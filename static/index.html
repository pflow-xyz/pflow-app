<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pflow | model.svg</title>
    <style>
        body {
            background-color: #f0f0f0;
        }
        #svgCanvas {
            width: 100%;
            height: 100%;
            position: absolute;
            user-select: none;
        }
        #svgObject {
            width: 100%;
            height: 600px;
            position: absolute;
            top: 0;
            left: 0;
        }
        #playBtn {
            cursor: pointer;
            fill: #333;
            transition: fill 0.3s ease;
        }
        #title {
            position: absolute;
            z-index: 10;
        }
        #history {
            border: 1px solid black;
        }
        .history.item {
            fill: #fff;
            stroke: #ccc;
            stroke-width: 1;
            opacity: 0.5;
            width: 200px;
            height: 17px;
        }
        #source {
            width: 100%;
            min-height: 370px;
            padding: 10px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fff;
            overflow: auto;
            resize: both;
            font-family: monospace;
        }
        #source:focus {
            outline: darkgray;
        }
    </style>
</head>
<body>
    <svg id="title" width="160px" height="40px" >
        <a href="https://pflow.xyz" >
            <rect x="0" y="0" width="160" height="40" fill="transparent" stroke="transparent" stroke-width="1" rx="5" ry="5"/>
            <g transform="translate( 5, 5) scale(.3,.3)">
                <title>pflow.xyz - PetriNet Metamodels</title>
                <path d="M100.88 28.02H78.46v5.61h-5.6v5.6h-5.6v-5.6h5.6v-5.61h5.6V5.6h-5.6V0H61.65v5.6h-5.6v28.02h-5.6V5.6h-5.6V0H33.64v5.6h-5.6v22.42h5.6v5.61h5.6v5.6h-5.6v-5.6h-5.6v-5.61H5.6v5.61H0v11.21h5.6v5.6h28.02v5.6H5.6v5.61H0v11.21h5.6v5.6h22.42v-5.6h5.6v-5.61h5.6v5.61h-5.6v5.6h-5.6v22.42h5.6v5.6h11.21v-5.6h5.6V72.86h5.6v28.02h5.6v5.6h11.21v-5.6h5.6V78.46h-5.6v-5.6h-5.6v-5.61h5.6v5.61h5.6v5.6h22.42v-5.6h5.6V61.65h-5.6v-5.61H72.84v-5.6h28.02v-5.6h5.6V33.63h-5.6v-5.61zM67.25 56.04v5.61h-5.6v5.6H44.84v-5.6h-5.6V44.84h5.6v-5.6h16.81v5.6h5.6v11.21zm89.89-28.02h-11.21v11.21h11.21zm33.63 11.21h11.21V28.02h-33.63v11.21z"/>
                <path d="M179.56 72.86h-11.21V39.23h-11.21v56.05h-11.21v11.21h33.63V95.28h-11.21V84.07h33.63V72.86zm22.42-22.42v22.42h11.21V39.23h-11.21zm33.63-22.42H224.4v11.21h11.21v33.63H224.4v11.21h33.63V72.86h-11.21V39.23h11.21V28.02h-11.21V16.81h-11.21z"/>
                <path d="M246.82 5.6v11.21h22.42V5.6zm56.05 56.05V5.6h-22.42v11.21h11.21v56.05h-11.21v11.21h33.63V72.86h-11.21zm33.63-11.21V39.23h-11.21v33.63h11.21zm22.42 0h-11.21v11.21h11.21zm0-11.21h11.21V28.02H336.5v11.21zm-11.21 33.63H336.5v11.21h33.63V72.86zm22.42-22.42v22.42h11.21V39.23h-11.21zm44.84-11.21V28.02h-22.42v11.21h11.21v22.42h11.21zm11.21 22.42h-11.21v11.21h11.21zm11.21 11.21h-11.21v11.21h11.21zm11.21-22.42V28.02h-11.21v44.84h11.21zm11.21 22.42H448.6v11.21h11.21zm11.21-11.21h-11.21v11.21h11.21zm11.21-33.63h-11.21v33.63h11.21V39.23h11.21V28.02z"/>
            </g>
        </a>
    </svg>
    <svg id="svgCanvas" width="100%" height="100%"  xmlns="http://www.w3.org/2000/svg">
    <foreignObject height="100%" width="100%" x="0" y="0">
        <object id="svgObject" type="image/svg+xml" data="./model.svg"></object>
    </foreignObject>
        <g id="status" transform="translate(5, 607)" >
            <rect x="0" y="0" width="140" height="20" fill="#fff" rx="5" ry="5"/>
            <text x="10" y="15">Status: Ready</text>
        </g>
        <g id="playBtn" transform="translate(148, 604)" >
            <circle cx="12" cy="11" r="20" fill="transparent" stroke="transparent" stroke-width="2" />
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m-2.5-3.5 7-4.5-7-4.5z"></path>
        </g>
        <g id="sourceButton" transform="translate(175, 605)" >
            <path d="M18 2H9c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h9c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 14H9V4h9zM3 15v-2h2v2zm0-5.5h2v2H3zM10 20h2v2h-2zm-7-1.5v-2h2v2zM5 22c-1.1 0-2-.9-2-2h2zm3.5 0h-2v-2h2zm5 0v-2h2c0 1.1-.9 2-2 2M5 6v2H3c0-1.1.9-2 2-2"/>
        </g>
        <g id="history" transform="translate(5, 605)" ></g>
    <foreignObject height="50%" width="98%" x="0" y="635">
<textarea id="source">{
  "modelType": "PetriNet",
  "version": "v1",
  "tokens": ["black"],
  "places": {
    "place0": { "offset": 0, "initial": [1], "capacity": [3], "x": 130, "y": 207 }
  },
  "transitions": {
    "txn0": { "x": 46, "y": 116 },
    "txn1": { "x": 227, "y": 112 },
    "txn2": { "x": 43, "y": 307 },
    "txn3": { "x": 235, "y": 306 }
  },
  "arcs": [
    { "source": "txn0", "target": "place0", "weight": [1] },
    { "source": "place0", "target": "txn1", "weight": [3] },
    { "source": "txn2", "target": "place0", "weight": [3], "inhibit": true },
    { "source": "place0", "target": "txn3", "weight": [1], "inhibit": true }
  ]
}</textarea>
    </foreignObject>
    </svg>
    <script>
        // set the origin for postMessage
        const origin = "*";
        // Get the model data from the meta tag
        let model = {};
        let eventLog = [];
        let nonce = 0;
        let modelData = document.querySelector('#source');
        if (!modelData) {
            console.error('Model data not found in the meta tag.');
        }
        try {
            if (modelData && modelData.textContent) {
                // Parse the JSON data
                model = JSON.parse(modelData.textContent);
            } else {
                console.error('Model data is empty or invalid.');
            }
            if (typeof model !== 'object' || !model) {
                console.error('Parsed model is not an object:', model);
            }
        } catch (e) {
            console.error('Error parsing model data:', e);
        }

        function init() {
            const svg = document.getElementById('svgObject');
            if (!svg || !svg.contentWindow) {
                console.error('SVG object not found or not loaded yet.');
                return;
            }
            svg.contentWindow.postMessage({ type: 'setModel', model: model }, origin); // Send the model to the SVG
            const playBtn = document.getElementById('playBtn');
            const modelData = document.getElementById('source');

            function reset() {
                if (modelData) {
                    modelData.style.display = 'block';
                }
                // Change the status text
                const statusText = document.querySelector('#status text');
                if (statusText) {
                    statusText.textContent = 'Status: Restarted';
                }
                // set timeout for 1 second to change the status back to running
                setTimeout(() => {
                    const statusText = document.querySelector('#status text');
                    if (statusText) {
                        statusText.textContent = 'Status: Running';
                    }
                }, 1000);
                nonce = 0;
                eventLog = [];
                RenderHistory();
            }

            function restart() {
                if (!svg.contentWindow) {
                    console.error('SVG contentWindow not available.');
                    return;
                }
                svg.contentWindow.postMessage({ type: 'restart' }, origin);
                reset()
            }

            playBtn.addEventListener('click', () => restart());

            // update model after edit in the textarea
            if (modelData) {
                modelData.addEventListener('input', function() {
                    try {
                        const newModel = JSON.parse(modelData.value);
                        if (typeof newModel === 'object' && newModel) {
                            model = newModel;
                            svg.contentWindow.postMessage({ type: 'setModel', model: model }, origin); // Send the updated model to the SVG
                            //console.log('Updated model:', model);
                        } else {
                            //console.error('Invalid model format:', newModel);
                        }
                    } catch (e) {
                        //console.error('Error parsing model data:', e);
                    }
                });
            }

            function RenderHistory() {
                const fragment = document.createDocumentFragment();
                // history in reverse order

                eventLog.forEach((event, index) => {
                    const offset = 26
                    const newText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    newText.setAttribute('x', '10');
                    newText.setAttribute('y', `${offset + (eventLog.length - index) * 19-3}`);
                    // string pad 8 chars to left
                    newText.textContent = `${(index + 1).toString().padStart(3, '0')}.  ${event.transitionId}`;
                    newText.setAttribute('stroke', '#222');

                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute('x', '0');
                    rect.setAttribute('y', `${offset+2 + index * 19}`);
                    rect.setAttribute('class', 'history item');
                    rect.setAttribute('fill', '#fff');
                    rect.setAttribute('rx', '5');
                    rect.setAttribute('ry', '5');
                    fragment.appendChild(rect);
                    fragment.appendChild(newText);
                });
                const history = document.getElementById('history');
                if (history) {
                    while (history.childNodes.length > 1) {
                        history.removeChild(history.lastChild);
                    }
                    history.appendChild(fragment);
                }
            }

            window.addEventListener('message', function(event) {
                if (event.origin !== window.location.origin) {
                    console.error('Invalid origin:', event.origin);
                    return;
                }
                if (event.data.type === "reset") {
                    reset();
                }
                if (event.data.type === 'transitionFired') {
                    // KLUDGE getting notified 2x
                    if (nonce === event.data.sequence) {
                        return;
                    } else {
                        nonce = event.data.sequence;
                    }
                    // add to front
                    eventLog.push(event.data);
                    RenderHistory();
                    // hide the data
                    const modelData = document.getElementById('source');
                    if (modelData) {
                        modelData.style.display = 'none';
                    }
                } else if (event.data.type === 'error') {
                    console.error('Error from SVG:', event.data.message);
                } else if (event.data.type === 'resize') {
                    render(svg);
                } else {
                    //console.log('Unknown message type:', event.data.type);
                }
            }, false);
            render(svg)
        }

        function render(svg) {
            const width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            svg.contentWindow.postMessage({ type: 'resize', width: width-15, height: 600 }, origin);
        }

        // FIXME doesn't scale properly on resize
        //window.addEventListener('resize', render);
        window.addEventListener('load', init);
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
